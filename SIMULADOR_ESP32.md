# üì± Simulador de C√°maras ESP32-CAM

## üéØ ¬øQu√© es esto?

Un simulador que **act√∫a como si fueran 12 c√°maras ESP32-CAM reales** enviando datos de aforo al sistema ElevaTec.

## üöÄ Funcionamiento

El simulador:
- ‚úÖ Simula **12 c√°maras ESP32** diferentes
- ‚úÖ Env√≠a datos cada **5 segundos** (configurable)
- ‚úÖ Genera conteos **realistas** de personas
- ‚úÖ Simula **variaciones graduales** (personas que entran/salen)
- ‚úÖ Respeta **horas pico** (m√°s gente entre 8-10am, 12-2pm, 5-7pm)
- ‚úÖ Muestra estado en **tiempo real** con colores

## üì± C√°maras Simuladas

### Ascensores (2 c√°maras)
```
ESP32CAM-001 ‚Üí Ascensor Torre A    (Capacidad: 10)
ESP32CAM-002 ‚Üí Ascensor Torre B    (Capacidad: 10)
```

### Salones (3 c√°maras)
```
ESP32CAM-101 ‚Üí Sal√≥n A-301 (Piso 3, Capacidad: 45)
ESP32CAM-102 ‚Üí Sal√≥n A-302 (Piso 3, Capacidad: 45)
ESP32CAM-103 ‚Üí Sal√≥n B-205 (Piso 2, Capacidad: 40)
```

### Bibliotecas (2 c√°maras)
```
ESP32CAM-201 ‚Üí Biblioteca Central        (Piso 1, Capacidad: 80)
ESP32CAM-202 ‚Üí Biblioteca Especializada  (Piso 2, Capacidad: 30)
```

### Cafeter√≠as (2 c√°maras)
```
ESP32CAM-301 ‚Üí Cafeter√≠a Principal   (Piso 1, Capacidad: 120)
ESP32CAM-302 ‚Üí Cafeter√≠a Secundaria  (Piso 1, Capacidad: 60)
```

### Laboratorios (2 c√°maras)
```
ESP32CAM-401 ‚Üí Lab de F√≠sica   (Piso 2, Capacidad: 25)
ESP32CAM-402 ‚Üí Lab de Qu√≠mica  (Piso 2, Capacidad: 25)
```

### Gimnasio (1 c√°mara)
```
ESP32CAM-501 ‚Üí Gimnasio  (Piso 1, Capacidad: 40)
```

**Total: 12 c√°maras simuladas**

---

## üéÆ Uso B√°sico

### Opci√≥n 1: Con Docker Compose (Recomendado)

El simulador ya est√° incluido en el `docker-compose.yml`:

```bash
# Iniciar todo (incluye simulador)
docker-compose up -d

# Ver logs del simulador en tiempo real
docker-compose logs -f simulator
```

Ver√°s algo como:
```
üü¢ ESP32CAM-101     |  23/ 45 personas | BAJO   | C√°mara Sal√≥n A-301
üü° ESP32CAM-201     |  67/ 80 personas | MEDIO  | C√°mara Biblioteca Central
üî¥ ESP32CAM-301     |  98/120 personas | ALTO   | C√°mara Cafeter√≠a Principal
```

### Opci√≥n 2: Ejecutar Manualmente (Sin Docker)

```bash
# Instalar dependencias
pip install requests

# Ejecutar simulador
python esp32_camera_simulator.py
```

---

## ‚öôÔ∏è Configuraci√≥n

### Variables de Entorno

Puedes cambiar el comportamiento del simulador:

```yaml
# En docker-compose.yml
simulator:
  environment:
    BACKEND_URL: http://backend:5000      # URL del backend
    INTERVAL_SECONDS: 5                   # Segundos entre env√≠os (default: 5)
```

**Opciones:**
- `INTERVAL_SECONDS: 2` ‚Üí Env√≠a datos cada 2 segundos (muy r√°pido)
- `INTERVAL_SECONDS: 10` ‚Üí Env√≠a datos cada 10 segundos (m√°s lento)
- `INTERVAL_SECONDS: 30` ‚Üí Env√≠a datos cada 30 segundos (muy lento)

### Modificar en docker-compose.yml:

```bash
# 1. Editar docker-compose.yml
nano docker-compose.yml

# 2. Cambiar INTERVAL_SECONDS
simulator:
  environment:
    INTERVAL_SECONDS: 10  # ‚Üê Cambiar aqu√≠

# 3. Reiniciar simulador
docker-compose restart simulator
```

---

## üìä Caracter√≠sticas del Simulador

### 1. Variaci√≥n Realista

El simulador **NO** genera n√∫meros aleatorios. En su lugar:

- ‚úÖ Los n√∫meros cambian **gradualmente**
- ‚úÖ Simula personas que **entran y salen**
- ‚úÖ No hay saltos bruscos (ej: de 10 a 45 personas)
- ‚úÖ Respeta la capacidad m√°xima

**Ejemplo:**
```
10:00 ‚Üí 23 personas
10:05 ‚Üí 25 personas (+2)
10:10 ‚Üí 27 personas (+2)
10:15 ‚Üí 24 personas (-3)
```

### 2. Horas Pico

El simulador detecta la hora actual y ajusta el comportamiento:

**Horas Pico** (8-10am, 12-2pm, 5-7pm):
- 60% probabilidad de **aumentar** personas
- 20% probabilidad de mantener igual
- 20% probabilidad de disminuir

**Horas Normales**:
- 33% probabilidad de aumentar
- 33% probabilidad de mantener
- 33% probabilidad de disminuir

### 3. Indicadores Visuales

El simulador muestra el estado con colores:

```
üü¢ BAJO   ‚Üí < 50% ocupaci√≥n (verde)
üü° MEDIO  ‚Üí 50-80% ocupaci√≥n (amarillo)
üî¥ ALTO   ‚Üí > 80% ocupaci√≥n (rojo)
```

---

## üéØ Ejemplo de Output

```bash
docker-compose logs -f simulator
```

**Output:**
```
================================================================================
  ESP32-CAM SIMULATOR - ElevaTec
================================================================================
  Backend: http://backend:5000
  C√°maras: 12
  Intervalo: 5 segundos
================================================================================

‚úÖ Backend disponible!

[2025-10-29 22:30:15] Iteraci√≥n #1
--------------------------------------------------------------------------------
üü¢ ESP32CAM-001     |   3/ 10 personas | BAJO   | C√°mara Ascensor Torre A
üü¢ ESP32CAM-002     |   5/ 10 personas | BAJO   | C√°mara Ascensor Torre B
üü¢ ESP32CAM-101     |  23/ 45 personas | BAJO   | C√°mara Sal√≥n A-301
üü¢ ESP32CAM-102     |  18/ 45 personas | BAJO   | C√°mara Sal√≥n A-302
üü° ESP32CAM-103     |  32/ 40 personas | MEDIO  | C√°mara Sal√≥n B-205
üü° ESP32CAM-201     |  67/ 80 personas | MEDIO  | C√°mara Biblioteca Central
üü¢ ESP32CAM-202     |  12/ 30 personas | BAJO   | C√°mara Biblioteca Especializada
üî¥ ESP32CAM-301     |  98/120 personas | ALTO   | C√°mara Cafeter√≠a Principal
üü° ESP32CAM-302     |  45/ 60 personas | MEDIO  | C√°mara Cafeter√≠a Secundaria
üü¢ ESP32CAM-401     |  15/ 25 personas | BAJO   | C√°mara Lab de F√≠sica
üü° ESP32CAM-402     |  18/ 25 personas | MEDIO  | C√°mara Lab de Qu√≠mica
üü° ESP32CAM-501     |  28/ 40 personas | MEDIO  | C√°mara Gimnasio

--------------------------------------------------------------------------------
  üìä RESUMEN: 364/500 personas (72.8% ocupaci√≥n global)
--------------------------------------------------------------------------------

‚úÖ 12/12 c√°maras enviaron datos correctamente
‚è≥ Pr√≥xima actualizaci√≥n en 5 segundos...
```

---

## üîß Comandos √ötiles

### Ver logs del simulador
```bash
docker-compose logs -f simulator
```

### Detener el simulador
```bash
docker-compose stop simulator
```

### Iniciar solo el simulador
```bash
docker-compose start simulator
```

### Reiniciar el simulador
```bash
docker-compose restart simulator
```

### Ver estado del simulador
```bash
docker-compose ps simulator
```

### Eliminar y recrear el simulador
```bash
docker-compose stop simulator
docker-compose rm -f simulator
docker-compose up -d --build simulator
```

---

## üé® Personalizar C√°maras

Puedes editar el archivo `esp32_camera_simulator.py` para:

### Agregar m√°s c√°maras:

```python
CAMERAS = [
    # ... c√°maras existentes ...

    # Nueva c√°mara
    {
        'device_id': 'ESP32CAM-999',
        'name': 'C√°mara Mi Nuevo Espacio',
        'floor': 5,
        'capacity': 50,
        'min_people': 10,
        'max_people': 48,
        'variation': 5
    },
]
```

### Cambiar comportamiento de una c√°mara:

```python
{
    'device_id': 'ESP32CAM-301',
    'name': 'C√°mara Cafeter√≠a Principal',
    'floor': 1,
    'capacity': 120,
    'min_people': 50,      # ‚Üê Siempre tiene m√≠nimo 50 personas
    'max_people': 118,     # ‚Üê M√°ximo 118 (casi siempre llena)
    'variation': 20        # ‚Üê Cambios m√°s dr√°sticos
},
```

**Despu√©s de editar:**
```bash
docker-compose restart simulator
```

---

## üêõ Troubleshooting

### Problema 1: Simulador no env√≠a datos

**S√≠ntomas:**
```
‚ö†Ô∏è  ESP32CAM-001     | Backend no disponible (esperando...)
```

**Soluci√≥n:**
```bash
# Verificar que backend est√© corriendo
docker-compose ps backend

# Ver logs del backend
docker-compose logs backend

# Reiniciar backend
docker-compose restart backend

# Esperar 10 segundos
sleep 10

# Reiniciar simulador
docker-compose restart simulator
```

### Problema 2: Error "Connection refused"

**Causa:** Backend no est√° listo o no est√° en la misma red

**Soluci√≥n:**
```bash
# Verificar que est√©n en la misma red
docker network inspect proyectofinal_elevatec_network

# Reiniciar todo
docker-compose down
docker-compose up -d
```

### Problema 3: Simulador se detiene solo

**S√≠ntomas:**
```
docker-compose ps simulator
# Estado: Exited
```

**Soluci√≥n:**
```bash
# Ver logs para identificar el error
docker-compose logs simulator

# Reconstruir imagen
docker-compose up -d --build simulator
```

### Problema 4: Quiero cambiar el intervalo sin editar archivo

**Soluci√≥n:**
```bash
# Detener simulador
docker-compose stop simulator

# Ejecutar con nuevo intervalo
docker-compose run -e INTERVAL_SECONDS=10 simulator
```

---

## üìà Verificar que Funciona

### 1. Ver logs del simulador
```bash
docker-compose logs -f simulator
```

Deber√≠as ver datos envi√°ndose cada 5 segundos.

### 2. Verificar en el frontend
```bash
open http://localhost:5173
```

Deber√≠as ver los espacios actualiz√°ndose autom√°ticamente.

### 3. Verificar con curl
```bash
curl http://localhost:5002/api/elevators
```

Deber√≠as ver JSON con los ascensores y su ocupaci√≥n actual.

### 4. Ver en la base de datos
```bash
docker exec -it elevatec_db psql -U elevadmin -d elevadb -c "SELECT COUNT(*) FROM aforo_logs;"
```

El n√∫mero deber√≠a aumentar cada 5 segundos √ó 12 c√°maras = +12 logs cada 5 segundos.

---

## üéØ Casos de Uso

### Caso 1: Demo r√°pida
```bash
# Intervalo de 2 segundos para ver cambios r√°pidos
docker-compose stop simulator
docker-compose run -e INTERVAL_SECONDS=2 simulator
```

### Caso 2: Simulaci√≥n realista
```bash
# Intervalo de 30 segundos (m√°s realista)
docker-compose stop simulator
docker-compose run -e INTERVAL_SECONDS=30 simulator
```

### Caso 3: Testing de carga
```bash
# Intervalo de 1 segundo (m√°xima carga)
docker-compose stop simulator
docker-compose run -e INTERVAL_SECONDS=1 simulator
```

---

## üéì C√≥mo Funciona Internamente

### 1. Inicializaci√≥n
```python
# Al arrancar, cada c√°mara obtiene un valor inicial aleatorio
camera_state = {
    'ESP32CAM-001': 5,   # Ascensor con 5 personas
    'ESP32CAM-101': 23,  # Sal√≥n con 23 personas
    # ...
}
```

### 2. Generaci√≥n de Datos
```python
# En cada iteraci√≥n:
# 1. Lee el valor anterior
current = 23

# 2. Decide tendencia seg√∫n hora
if hora_pico:
    trend = +1  # M√°s probable aumentar

# 3. Aplica variaci√≥n peque√±a
variation = random(0, 5)
new_count = current + (trend * variation)  # 23 + 5 = 28

# 4. Respeta l√≠mites
new_count = min(max_people, new_count)  # No > 45
```

### 3. Env√≠o al Backend
```python
# Env√≠a POST /api/data
{
    "device_id": "ESP32CAM-101",
    "floor": 3,
    "people_count": 28,
    "capacity": 45,
    "timestamp": "2025-10-29T22:30:15Z"
}
```

### 4. Respuesta del Backend
```python
# Backend responde:
{
    "message": "Data received successfully",
    "aforo_status": "bajo"  # porque 28/45 = 62% ‚Üí medio
}
```

---

## üöÄ Pr√≥ximos Pasos

Despu√©s de tener el simulador corriendo:

1. ‚úÖ Abre el frontend: http://localhost:5173
2. ‚úÖ Login: admin@elevatec.com / admin123
3. ‚úÖ Ver√°s los espacios actualiz√°ndose autom√°ticamente cada 5 segundos
4. ‚úÖ Los n√∫meros cambian gradualmente (como en la realidad)

---

## üìù Resumen

**¬øQu√© hace?**
- Simula 12 c√°maras ESP32-CAM enviando datos reales

**¬øCada cu√°nto env√≠a?**
- Cada 5 segundos (configurable)

**¬øC√≥mo iniciar?**
```bash
docker-compose up -d
```

**¬øC√≥mo ver logs?**
```bash
docker-compose logs -f simulator
```

**¬øC√≥mo detener?**
```bash
docker-compose stop simulator
```

---

¬°Listo! üéâ Ahora tienes un sistema completo con datos simulados en tiempo real.
